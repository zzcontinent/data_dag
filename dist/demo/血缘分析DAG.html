<!doctype html>

<meta charset="utf-8">
<title>血缘分析DAG</title>

<link rel="stylesheet" href="demo.css">
<script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
<script src="./dagre-d3.js"></script>

<!-- Pull in JQuery dependencies -->
<link rel="stylesheet" href="tipsy.css">
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="tipsy.js"></script>

<style id="css">
  text {
    font-weight: 300;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
    font-size: 14px;
  }

  .node rect {
    stroke: #333;
    fill: #fff;
  }

  .edgePath path {
    stroke: #333;
    fill: #333;
    stroke-width: 1.5px;
  }

  .node text {
    pointer-events: none;
  }

  /* This styles the title of the tooltip */
  .tipsy .name {
    font-size: 1.5em;
    font-weight: bold;
    color: #60b1fc;
    margin: 0;
  }

  /* This styles the body of the tooltip */
  .tipsy .description {
    font-size: 1.2em;
  }

</style>

<h3>jff_online_service中一个案例</h3>
<svg width=960 height=800 id="svg1"></svg>
<script>
  var highlight_color = "#000000";
  var upstream_color = "#0000FF";
  var downstream_color = "#0000FF"
  var fill_default_color = "rgb(240, 237, 228)"
  var fill_upstream_color = "orange"
  var fill_downstream_color = "orange"
  var initialStrokeWidth = '3px';
  
  // Create a new directed graph
  var g1 = new dagreD3.graphlib.Graph().setGraph({});

  // States and transitions from RFC 793
  var states = {
    "id_1": {
    id: "id_1",
    label: "SQL",
    description: "<br>    INSERT INTO transit_jff.direct_store_name_list_sum(sp_id, league_id, league_name, ent_id, ent_short_name, sp_ent_id, sum_wage_min, sum_wage_max, intv_cnt)<br>SELECT a.sp_id,<br>       b.league_id,<br>       b.league_name,<br>       d.ent_id,<br>       d.ent_short_name,<br>       a.sp_ent_id,<br>       d.sum_wage_min,<br>       d.sum_wage_max,<br>       count(1) AS intv_cnt<br>FROM ods_jff.name_list a<br>LEFT JOIN ods_jff.league_store b ON a.sp_id = b.sp_id<br>LEFT JOIN ods_jff.sp_ent c ON a.sp_ent_id = c.sp_ent_id<br>LEFT JOIN ods_jff.ent d ON c.ent_id = d.ent_id<br>WHERE a.is_deleted = 0 -- and b.coop_mode = 3<br>AND b.is_deleted = 0<br>  AND d.ent_id > 0<br>  AND a.intv_dt >= date_sub(current_date(), interval 1 MONTH)<br>GROUP BY a.sp_id,<br>         b.league_id,<br>         b.league_name,<br>         d.ent_id,<br>         d.ent_short_name,<br>         a.sp_ent_id,<br>         d.sum_wage_min,<br>         d.sum_wage_max;<br>    ",
    style: "fill: lightblue"
  },
  "id_2": {
    id: "id_2",
    label: "ods_jff.name_list",
    description: "表",
    style: "fill: blue"
  },
  "id_3": {
    id: "id_3",
    label: "ods_jff.league_store",
    description: "表",
    style: "fill: blue"
  },
  "id_4": {
    id: "id_4",
    label: "ods_jff.sp_ent",
    description: "表",
    style: "fill: blue"
  },
  "id_5": {
    id: "id_5",
    label: "ods_jff.ent",
    description: "表",
    style: "fill: blue"
  },
  "id_6": {
    id: "id_6",
    label: "sum_wage_max",
    description: "字段",
    style: "fill: orange"
  },
  "id_7": {
    id: "id_7",
    label: "league_id",
    description: "字段",
    style: "fill: orange"
  },
  "id_8": {
    id: "id_8",
    label: "sum_wage_min",
    description: "字段",
    style: "fill: orange"
  },
  "id_9": {
    id: "id_9",
    label: "ent_short_name",
    description: "字段",
    style: "fill: orange"
  },
  "id_10": {
    id: "id_10",
    label: "sp_id",
    description: "字段",
    style: "fill: orange"
  },
  "id_11": {
    id: "id_11",
    label: "#meta2",
    description: "字段 | count ( 1 ) ",
    style: "fill: orange"
  },
  "id_12": {
    id: "id_12",
    label: "sp_ent_id",
    description: "字段",
    style: "fill: orange"
  },
  "id_ts": {
    id: "id_ts",
    label: "开始",
    description: "开始",
    style: "fill: red"
  },
  "id_14": {
    id: "id_14",
    label: "league_name",
    description: "字段",
    style: "fill: orange"
  },
  "id_13": {
    id: "id_13",
    label: "ent_id",
    description: "字段",
    style: "fill: orange"
  },
  "id_15": {
    id: "id_15",
    label: "intv_cnt",
    description: "字段别名",
    style: "fill: pink"
  }
  };

  // Add states to the graph, set labels, and style
  Object.keys(states).forEach(function (state) {
    var value = states[state];
    value.rx = value.ry = 5;
    g1.setNode(state, value);
  });

  // Set up the edges
  g1.setEdge( "id_ts", "id_1" , { label: "" });
g1.setEdge( "id_11", "id_15" , { label: "" });
g1.setEdge( "id_5", "id_6" , { label: "" });
g1.setEdge( "id_3", "id_7" , { label: "" });
g1.setEdge( "id_5", "id_8" , { label: "" });
g1.setEdge( "id_5", "id_9" , { label: "" });
g1.setEdge( "id_2", "id_10" , { label: "" });
g1.setEdge( "id_1", "id_11" , { label: "" });
g1.setEdge( "id_2", "id_12" , { label: "" });
g1.setEdge( "id_5", "id_13" , { label: "" });
g1.setEdge( "id_3", "id_14" , { label: "" });
g1.setEdge( "id_1", "id_5" , { label: "" });
g1.setEdge( "id_1", "id_3" , { label: "" });
g1.setEdge( "id_1", "id_2" , { label: "" });
g1.setEdge( "id_1", "id_4" , { label: "" });


  // Create the renderer
  var render = new dagreD3.render();

  // Set up an SVG group so that we can translate the final graph.
  var svg = d3.select("#svg1"),
    inner1 = svg.append("g");

  // Set up zoom support
  var zoom = d3.zoom()
    .on("zoom", function () {
      inner1.attr("transform", d3.event.transform);
    });
  svg.call(zoom);

  // Simple function to style the tooltip for the given node.
  var styleTooltip = function (name, description) {
    return "<p class='name'>" + name + "</p><p class='description' style='color:orange; width:100%; height:100%; display:inline-block' >" + description +"<br>" + "</p>";
  };

  // Run the renderer. This is what draws the final graph.
  render(inner1, g1);

  inner1.selectAll("g.node")
    .attr("title", function (v) { return styleTooltip(g1.node(v).label, g1.node(v).description) })
    .each(function (v) { $(this).tipsy({ gravity: "w", opacity: 1, html: true }); });

  inner1.selectAll("g.node").style("stroke-width", initialStrokeWidth);

  // function highlight nodes
  inner1.selectAll("g.node").on("mouseover", function (d) {
    inner1.selectAll("rect").style("stroke", highlight_color);
    g1.predecessors(d).forEach(function (nodeid) {
      my_node = inner1.select('#' + nodeid + ' rect');
      my_node.style("stroke", fill_upstream_color);
    })

    g1.successors(d).forEach(function (nodeid) {
      my_node = inner1.select('#' + nodeid + ' rect');
      my_node.style("stroke", fill_downstream_color);
    })
  });

  inner1.selectAll("g.node").on("mouseout", function (d) {
    inner1.selectAll("rect").style("stroke", null);
    g1.predecessors(d).forEach(function (nodeid) {
      my_node = inner1.select('#' + nodeid + ' rect');
      my_node.style("stroke", null);
    })

    g1.successors(d).forEach(function (nodeid) {
      my_node = inner1.select('#' + nodeid + ' rect');
      my_node.style("stroke", null);
    })
  });
  
  // Center the graph
  var initialScale = 0.75;
  svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g1.graph().width * initialScale) / 2, 20).scale(initialScale));

  svg.attr('height', g1.graph().height * initialScale + 40);
</script>

<h3>周鑫案例1</h3>
<svg width=960 height=800 id="svg2"></svg>
<script>
  var highlight_color = "#000000";
  var upstream_color = "#0000FF";
  var downstream_color = "#0000FF"
  var fill_default_color = "rgb(240, 237, 228)"
  var fill_upstream_color = "orange"
  var fill_downstream_color = "orange"
  var initialStrokeWidth = '3px';
  
  // Create a new directed graph
  var g2 = new dagreD3.graphlib.Graph().setGraph({});

  // States and transitions from RFC 793
  var states = {
    "id_1": {
    id: "id_1",
    label: "SQL",
    description: "<br>        SELECT user_sk, count(distinct (intv_dt_sk, ent_sk)) as intv_cnt, <br>round(count(distinct (case when intv_sts=2 then (intv_dt_sk, ent_sk) else null end))/(count(distinct (intv_dt_sk, ent_sk))+0),2) as intv_sccs_rt, <br>round(count(distinct (case when fdbk_sts=2 then (intv_dt_sk, ent_sk) else null end))/(count(distinct (intv_dt_sk, ent_sk))+0),2) as hr_rt,<br>case when count(fdbk_sts=2 or null)=0 then count(distinct (intv_dt_sk, ent_sk)) else<br>round((count(distinct (intv_dt_sk, ent_sk))+0.0)/count(distinct (case when fdbk_sts=2 then (intv_dt_sk, ent_sk) else null end))) end as hr_per_intv_cnt<br>, max(event_tm) as max_intv_dt, min(event_tm) as min_intv_dt,<br>date_part('day', CURRENT_TIMESTAMP-min(event_tm))+1 as intv_dys,<br>round(count(distinct (intv_dt_sk, ent_sk))/(date_part('year', CURRENT_TIMESTAMP-min(event_tm))+1)::numeric,2) as intv_frq,<br>round(count(distinct (case when is_inner<2 then (intv_dt_sk, ent_sk) else null end))/count(distinct (intv_dt_sk, ent_sk))::numeric,2) as zxx_intv_rt,<br>min(case when is_inner<2 then event_tm else CURRENT_DATE end) as first_intv_zxx_tm<br>FROM dm.fact_interview<br>where is_deleted=0 and user_sk!=''<br>group by user_sk",
    style: "fill: lightblue"
  },
  "id_2": {
    id: "id_2",
    label: "dm.fact_interview",
    description: "表",
    style: "fill: blue"
  },
  "id_3": {
    id: "id_3",
    label: "#meta44",
    description: "字段 | CASE WHEN count ( fdbk_sts = 2 OR NULL ) = 0 THEN count ( ( intv_dt_sk ent_sk ) ) ELSE round ( ( count ( ( intv_dt_sk ent_sk ) ) + 0.0 ) / count ( ( CASE WHEN fdbk_sts = 2 THEN ( intv_dt_sk ent_sk ) ELSE NULL END ) ) ) END ",
    style: "fill: orange"
  },
  "id_4": {
    id: "id_4",
    label: "#meta43",
    description: "字段 | min ( CASE WHEN is_inner<2 THEN event_tm ELSE CURRENT_DATE END ) ",
    style: "fill: orange"
  },
  "id_5": {
    id: "id_5",
    label: "#meta42",
    description: "字段 | round ( count ( ( CASE WHEN is_inner<2 THEN ( intv_dt_sk ent_sk ) ELSE NULL END ) ) / count ( ( intv_dt_sk ent_sk ) ) :: numeric 2 ) ",
    style: "fill: orange"
  },
  "id_6": {
    id: "id_6",
    label: "user_sk",
    description: "字段",
    style: "fill: orange"
  },
  "id_7": {
    id: "id_7",
    label: "#meta27",
    description: "字段 | max ( event_tm ) ",
    style: "fill: orange"
  },
  "id_8": {
    id: "id_8",
    label: "#meta16",
    description: "字段 | round ( count ( ( CASE WHEN fdbk_sts = 2 THEN ( intv_dt_sk ent_sk ) ELSE NULL END ) ) / ( count ( ( intv_dt_sk ent_sk ) ) + 0 ) 2 ) ",
    style: "fill: orange"
  },
  "id_9": {
    id: "id_9",
    label: "#meta2",
    description: "字段 | count ( ( intv_dt_sk ent_sk ) ) ",
    style: "fill: orange"
  },
  "id_10": {
    id: "id_10",
    label: "#meta30",
    description: "字段 | date_part ( 'day' CURRENT_TIMESTAMP - min ( event_tm ) ) + 1 ",
    style: "fill: orange"
  },
  "id_11": {
    id: "id_11",
    label: "#meta36",
    description: "字段 | round ( count ( ( intv_dt_sk ent_sk ) ) / ( date_part ( 'year' CURRENT_TIMESTAMP - min ( event_tm ) ) + 1 ) :: numeric 2 ) ",
    style: "fill: orange"
  },
  "id_12": {
    id: "id_12",
    label: "#meta9",
    description: "字段 | round ( count ( ( CASE WHEN intv_sts = 2 THEN ( intv_dt_sk ent_sk ) ELSE NULL END ) ) / ( count ( ( intv_dt_sk ent_sk ) ) + 0 ) 2 ) ",
    style: "fill: orange"
  },
  "id_13": {
    id: "id_13",
    label: "#meta28",
    description: "字段 | min ( event_tm ) ",
    style: "fill: orange"
  },
  "id_14": {
    id: "id_14",
    label: "hr_per_intv_cnt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_15": {
    id: "id_15",
    label: "first_intv_zxx_tm",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_16": {
    id: "id_16",
    label: "zxx_intv_rt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_17": {
    id: "id_17",
    label: "max_intv_dt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_18": {
    id: "id_18",
    label: "hr_rt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_19": {
    id: "id_19",
    label: "intv_cnt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_20": {
    id: "id_20",
    label: "intv_dys",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_21": {
    id: "id_21",
    label: "intv_frq",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_22": {
    id: "id_22",
    label: "intv_sccs_rt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_23": {
    id: "id_23",
    label: "min_intv_dt",
    description: "字段别名",
    style: "fill: pink"
  },
  "id_ts": {
    id: "id_ts",
    label: "开始",
    description: "开始",
    style: "fill: red"
  }
  };

  // Add states to the graph, set labels, and style
  Object.keys(states).forEach(function (state) {
    var value = states[state];
    value.rx = value.ry = 5;
    g2.setNode(state, value);
  });

  // Set up the edges
  g2.setEdge( "id_ts", "id_1" , { label: "" });
g2.setEdge( "id_3", "id_14" , { label: "" });
g2.setEdge( "id_4", "id_15" , { label: "" });
g2.setEdge( "id_5", "id_16" , { label: "" });
g2.setEdge( "id_7", "id_17" , { label: "" });
g2.setEdge( "id_8", "id_18" , { label: "" });
g2.setEdge( "id_9", "id_19" , { label: "" });
g2.setEdge( "id_10", "id_20" , { label: "" });
g2.setEdge( "id_11", "id_21" , { label: "" });
g2.setEdge( "id_12", "id_22" , { label: "" });
g2.setEdge( "id_13", "id_23" , { label: "" });
g2.setEdge( "id_2", "id_3" , { label: "" });
g2.setEdge( "id_2", "id_4" , { label: "" });
g2.setEdge( "id_2", "id_5" , { label: "" });
g2.setEdge( "id_2", "id_6" , { label: "" });
g2.setEdge( "id_2", "id_7" , { label: "" });
g2.setEdge( "id_2", "id_8" , { label: "" });
g2.setEdge( "id_2", "id_9" , { label: "" });
g2.setEdge( "id_2", "id_10" , { label: "" });
g2.setEdge( "id_2", "id_11" , { label: "" });
g2.setEdge( "id_2", "id_12" , { label: "" });
g2.setEdge( "id_2", "id_13" , { label: "" });
g2.setEdge( "id_1", "id_2" , { label: "" });


  // Create the renderer
  var render = new dagreD3.render();

  // Set up an SVG group so that we can translate the final graph.
  var svg = d3.select("#svg2"),
    inner2 = svg.append("g");

  // Set up zoom support
  var zoom = d3.zoom()
    .on("zoom", function () {
      inner2.attr("transform", d3.event.transform);
    });
  svg.call(zoom);

  // Simple function to style the tooltip for the given node.
  var styleTooltip = function (name, description) {
    return "<p class='name'>" + name + "</p><p class='description' style='color:orange; width:100%; height:100%; display:inline-block' >" + description +"<br>" + "</p>";
  };

  // Run the renderer. This is what draws the final graph.
  render(inner2, g2);

  inner2.selectAll("g.node")
    .attr("title", function (v) { return styleTooltip(g2.node(v).label, g2.node(v).description) })
    .each(function (v) { $(this).tipsy({ gravity: "w", opacity: 1, html: true }); });

  inner2.selectAll("g.node").style("stroke-width", initialStrokeWidth);

  // function highlight nodes
  inner2.selectAll("g.node").on("mouseover", function (d) {
    inner2.selectAll("rect").style("stroke", highlight_color);
    g2.predecessors(d).forEach(function (nodeid) {
      my_node = inner2.select('#' + nodeid + ' rect');
      my_node.style("stroke", fill_upstream_color);
    })

    g2.successors(d).forEach(function (nodeid) {
      my_node = inner2.select('#' + nodeid + ' rect');
      my_node.style("stroke", fill_downstream_color);
    })
  });

  inner2.selectAll("g.node").on("mouseout", function (d) {
    inner2.selectAll("rect").style("stroke", null);
    g2.predecessors(d).forEach(function (nodeid) {
      my_node = inner2.select('#' + nodeid + ' rect');
      my_node.style("stroke", null);
    })

    g2.successors(d).forEach(function (nodeid) {
      my_node = inner2.select('#' + nodeid + ' rect');
      my_node.style("stroke", null);
    })
  });
  
  // Center the graph
  var initialScale = 0.75;
  svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g2.graph().width * initialScale) / 2, 20).scale(initialScale));

  svg.attr('height', g2.graph().height * initialScale + 40);
</script>


